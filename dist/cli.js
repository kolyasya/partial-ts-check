#!/usr/bin/env node
import $ from"path";import S from"fs";import{execSync as C}from"child_process";import{createRequire as _}from"module";var b=e=>e.replace(/\\/g,"/"),W="ts-whitelist.js",H="ts-blacklist.js",I="tsconfig.json",j=process.cwd(),O=_($.join(j,"package.json"));function R(){let e=$.join(j,"package.json"),t=S.readFileSync(e,"utf8");return JSON.parse(t)}function w(...e){return $.join(j,...e)}function P(e){let t=w(e);if(!S.existsSync(t))return console.log(`\u2139\uFE0F  List file not found: ${e} (will be ignored)`),[];if(t.endsWith(".js")||t.endsWith(".cjs")){let c=O(t);return c.default||c}let r=S.readFileSync(t,"utf8");try{return JSON.parse(r)}catch{return r.split(/\r?\n/).map(c=>c.trim()).filter(Boolean)}}function v(){let t=R()["partial-ts-check"]||{};return{whiteListPath:t.whitelist||t.whiteList||W,blackListPath:t.blacklist||t.blackList||H,printFilesList:t.printFilesList??!0,tsconfig:t.tsconfig||I}}function D(e){let t=w(e);S.existsSync(t)||(console.error(`\u274C TypeScript config file not found: ${e}`),process.exit(1));let r=w("node_modules/typescript/bin/tsc");console.log(`\u2139\uFE0F  Running TypeScript check with config: ${e}`);let c="";try{return C(`${r} --noEmit --project ${e}`,{stdio:"pipe"}),{ok:!0,output:""}}catch(p){let m=p.stdout?.toString()??"",k=p.stderr?.toString()??"";return c=(m+k).trim()||p.message,{ok:!1,output:c}}}function J(e){let t=new Map;for(let r of e)t.has(r.file)||t.set(r.file,[]),t.get(r.file).push(r);return t}function U(){let{whiteListPath:e,blackListPath:t,printFilesList:r,tsconfig:c}=v();console.log("\u2139\uFE0F  Loading configuration:"),console.log(`  - Whitelist: ${e}`),console.log(`  - Blacklist: ${t}`),console.log(`  - TypeScript config: ${c}`);let p=P(e),m=P(t);console.log(`\u2139\uFE0F  Loaded ${p.length} whitelist pattern(s), ${m.length} blacklist pattern(s)`);let{ok:k,output:A}=D(c);k&&(console.log("\u2705 No TypeScript errors."),process.exit(0));let y=A.split(`
`).filter(Boolean).filter(o=>!m.some(n=>o.includes(b(n)))).filter(o=>o.trim()),E=/^(.*?)(?:\((\d+),(\d+)\))?: error TS(\d{4}): (.*)$/,N=o=>p.some(n=>b(o).includes(b(n))),L=[];for(let o of y){let n=E.exec(o);if(!n)continue;let l=n[1];if(!N(l))continue;let a=Number(n[2]||0),h=Number(n[3]||0),s=n[4],i=n[5];L.push({file:l,line:a,col:h,code:s,msg:i})}if(L.length>0){console.error(`\u274C ${L.length} TypeScript error(s) found in whitelisted files:`);let o=J(L),n=Array.from(o.keys()).sort(),l=[];for(let a of n){l.push(a);let h=o.get(a).sort((s,i)=>s.line-i.line||s.col-i.col);for(let s of h)l.push(`  (${s.line},${s.col}): error TS${s.code}: ${s.msg}`);l.push("")}console.error(l.join(`
`).trim()),process.exit(1)}if(console.log(`\u2705 No TypeScript errors in whitelisted files.

`),r&&y.length>0){let o=(()=>{let s=new Set,i=/^(.*): error TS(\d{4})/;return u=>{let f=u.match(i);if(f){let d=`${f[1]}: error TS${f[2]}`;if(!s.has(d))return s.add(d),d}}})(),n=s=>{let i=u=>u.match(/^(.*?)(\(\d+,\d+\))?: error TS\d{4}/)?.[1]||"";return[...s].sort((u,f)=>i(u).localeCompare(i(f)))},l=s=>{let i=s.filter(Boolean),u=g=>g.match(/^(.*\/)? .*?: error TS\d{4}/)?.[1]||"",f=g=>g.match(/^(.*?)(\(\d+,\d+\))?: error TS\d{4}/)?.[1]||"",d="",T="";return i.reduce((g,F)=>{let x=u(F),B=f(F);return d&&x!==d?g.push("",""):T&&B!==T&&g.push(""),g.push(F),d=x,T=B,g},[])},a=y.map(o),h=a.filter(Boolean).length;if(h>0){let s=l(n(a.filter(Boolean)));console.log(s.join(`
`),`

`),console.log(`\u2139\uFE0F  Found ${h} TypeScript error(s) (excluding blacklisted files)`,`

`)}}process.exit(0)}U();
//# sourceMappingURL=cli.js.map